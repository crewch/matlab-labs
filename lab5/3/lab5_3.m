%% 3. Исходное текстовое изображение
img = imread('A5_07_3.jpg');

f_gray = im2double(rgb2gray(img));

[rows, cols] = size(f_gray);

% Отображаем исходное изображение
figure;
imshow(f_gray, []);
title('Исходное изображение');

imwrite(f_gray, 'task5_07_original.jpg');

%% 3.1. Спектр изображения (центрированный)
% Вычисляем двумерное дискретное преобразование Фурье исходного изображения
F = fft2(f_gray); % комплексный спектр (без центрирования)

% Переносим нулевую частоту в центр спектра
F_c = fftshift(F); % центрированный спектр

% Амплитуда центрированного спектра
Amp = abs(F_c);

% Логарифмическое преобразование амплитуды для улучшения видимости
% слабых частотных составляющих
AmpL = log(1 + Amp); % логарифмический масштаб

% Отображаем амплитудный спектр
figure;
imshow(mat2gray(AmpL), []);
title('Амплитудный спектр (центрированный)');

imwrite(mat2gray(AmpL), 'task5_07_spectrum_centered.jpg');

%% 3.2. Разфокусировка — ФНЧ Баттерворта 2-го порядка

D0 = 50; % частота среза ФНЧ (радиус области низких частот в частотной плоскости)

% Формируем координатные сетки u и v в частотной области.
[u, v] = meshgrid( (-cols/2):(cols/2-1), (-rows/2):(rows/2-1) );

% Матрица расстояний до центра спектра: D(u,v) = sqrt(u^2 + v^2)
D = sqrt(u.^2 + v.^2);

n = 2; % порядок фильтра Баттерворта

% Передаточная функция ФНЧ Баттерворта 2-го порядка:
H_low = 1 ./ (1 + (D./D0).^(2*n));   % размер фильтра совпадает с размером изображения

% Визуализируем сам фильтр (в частотной области)
figure;
imshow(mat2gray(H_low), []);
title('ФНЧ Баттерворта (D0 = 50)');

% Сохраняем изображение фильтра
imwrite(mat2gray(H_low), 'task5_07_filter_low_butterworth.jpg');

% Применяем ФНЧ к центрированному спектру:
% домножаем спектр изображения на частотную характеристику фильтра
F_low = F_c .* H_low;

% Переходим обратно в пространственную область:
% сначала отменяем центрирование (ifftshift),
% затем выполняем обратное ДПФ
f_low = real(ifft2(ifftshift(F_low)));

% Отображаем полученное разфокусированное изображение
figure;
imshow(mat2gray(f_low), []);
title('Разфокусированное изображение (ФНЧ Баттерворт)');

imwrite(mat2gray(f_low), 'task5_07_low_filtered.jpg');

%% 3.3. Повышение резкости через Лапласиан в частотной области

% Определяем пространственную маску Лапласиана
% Эта маска выделяет переходы яркости (вторые производные).
L = -1*[-1 -1 -1; -1 8 -1; -1 -1 -1];

% Создаём нулевую матрицу размера изображения
L_pad = zeros(rows, cols);

% В левый верхний угол вставляем маску Лапласиана
% При вычислении ДПФ эта маска будет дополнена нулями до размеров изображения.
L_pad(1:3, 1:3) = L;

% Вычисляем спектр маски Лапласиана и центрируем его
L_fft = fftshift(fft2(L_pad));

% Отображаем модуль спектра Лапласиана
figure;
imshow(mat2gray(abs(L_fft)), []);
title('Спектр Лапласиана');

imwrite(mat2gray(abs(L_fft)), 'task5_07_laplacian_spectrum.jpg');

% Строим центрированный спектр разфокусированного изображения
F_low_c = fftshift(fft2(f_low));

% Выполняем фильтрацию в частотной области:
% домножаем спектр разфокусированного изображения на спектр Лапласиана
F_sharp = F_low_c .* L_fft;

% Обратное ДПФ (с предварительным ifftshift для снятия центрирования)
f_sharp = real(ifft2(ifftshift(F_sharp)));

% Нормируем результат в диапазон [0,1]
f_sharp_enh = mat2gray(f_sharp);

% Применяем гамма-коррекцию с показателем 0.5 (gamma < 1):
% это усиливает контраст и слегка осветляет изображение,
% что подчёркивает детали и повышает визуальную резкость.
f_sharp_enh = f_sharp_enh .^ 0.5;

% Показываем результат повышения резкости
figure;
imshow(f_sharp_enh, []);
title('Увеличение резкости (Лапласиан + гамма-коррекция)');

imwrite(f_sharp_enh, 'task5_07_sharpened_laplacian.jpg');

%% 3.4. Выделение контуров — ФВЧ Гаусса

D0_high = 200; % частота среза для гауссовского ФВЧ

% Чистый гауссовский ФНЧ: exp(-D^2 / (2*D0^2))
% Гауссовский ФВЧ получаем как 1 - ФНЧ.
H_high = 1 - exp(-(D.^2) / (2*(D0_high^2)));   % Гауссов ФВЧ

% Отображаем фильтр высоких частот
figure;
imshow(mat2gray(H_high), []);
title('ФВЧ Гауссов (D0 = 200)');

% Сохраняем изображение фильтра
imwrite(mat2gray(H_high), 'task5_07_filter_high_gaussian.jpg');

% Применяем Гауссов ФВЧ к центрированному спектру исходного изображения
F_high = F_c .* H_high;

% Переход в пространственную область: снимаем центрирование и делаем ifft2
f_high = real(ifft2(ifftshift(F_high)));

% Отображаем результат – изображение, где подчёркнуты контуры
figure;
imshow(mat2gray(f_high), []);
imcontrast;
title('Выделение контуров (ФВЧ Гауссов)');

% Сохраняем изображение с контурами
imwrite(mat2gray(f_high), 'task5_07_edges_gaussian.jpg');
